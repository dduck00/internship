<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nts.reservation.dao.ReservationDao">
	<insert id="insertReservationInfo" parameterType="map" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO 
			reservation_info (
				product_id, 
				display_info_id, 
				reservation_name, 
				reservation_tel, 
				reservation_email, 
				reservation_date, 
				cancel_flag, 
				create_date, 
				modify_date)
		VALUES (
			#{productId}, 
			#{displayInfoid}, 
			#{reservationName}, 
			#{reservationTelephone}, 
			#{reservationEmail}, 
			#{reservationDate}, 
			0, 
			NOW(), 
			NOW())
	</insert>
	
	<insert id="insertReservationInfoPrice" parameterType="map" useGeneratedKeys="true" keyProperty="priceInfoList.id">
		INSERT INTO
			reservation_info_price (
				reservation_info_id,
				product_price_id,
				count)
		VALUES 
			<foreach collection="priceInfoList" item="priceInfo" index="index" separator=",">
				(#{reservationInfoId},
				#{priceInfo.productPriceId},
				#{priceInfo.count})
			</foreach>
	</insert>
	
	<select id="selectReservationList" parameterType="java.lang.String" resultType="ReservationInfo">
	SELECT
		id,
		cancel_flag 					AS cancelFlage,
		create_date 					AS createDate,
		display_info_id 				AS DisplayInfoId,
		modify_date 					AS modifyDate,
		product_id 						AS productId,
		reservation_date 				AS reservationDate,
		reservation_email 				AS reservationEmail,
		reservation_name 				AS reservationName,
		reservation_tel 				AS reservationTelephone,
		(
			SELECT
				SUM(price*(100-discount_rate)/100*count)
			FROM
				reservation_info_price
				INNER JOIN product_price
					ON reservation_info_price.product_price_id = product_price.id
			WHERE
				reservation_info_price.reservation_info_id = reservation_info.id)	AS totalPrice
	FROM
		reservation_info
	WHERE
		reservation_info.reservation_email = #{email}
</select>
</mapper>