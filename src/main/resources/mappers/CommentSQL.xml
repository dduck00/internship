<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nts.reservation.dao.CommentDao">
	
	<resultMap type="CommentImage" id="CommentImageMap">
	</resultMap>

	<resultMap type="CommentInfo" id="CommentResultMap">
		<id property="commentId" column="commentId"/>
		<result property="commentId" column="commentId"/>
		<result property="productId" column="productId"/>
		<result property="reservationInfoId" column="reservationInfoId"/>
		<result property="score" column="score"/>
		<result property="comment" column="comment"/>
		<result property="reservationName" column="reservationName"/>
		<result property="reservationTelephone" column="reservationTelephone"/>
		<result property="reservationEmail" column="reservationEmail"/>
		<result property="reservationDate" column="reservationDate"/>
		<result property="createDate" column="createDate"/>
		<result property="modifyDate" column="modifyDate"/>
		<collection property="commentImages" column="commentId" ofType="CommentImage" select="selectCommentImageList"/>
	</resultMap>

	
	<select id="selectCommentList" parameterType="map" resultMap="CommentResultMap">
		SELECT
			reservation_user_comment.id 		AS commentId,
			reservation_info.product_id 		AS productId,
			reservation_info.id 				AS reservationInfoId,
			reservation_user_comment.score 		AS score,
			reservation_user_comment.comment 	AS comment,
			reservation_info.reservation_name 	AS reservationName,
			reservation_info.reservation_tel 	AS reservationTelephone,
			reservation_info.reservation_email 	AS reservationEmail,
			reservation_info.reservation_date 	AS reservationDate,
			reservation_info.create_date 		AS createDate,
			reservation_info.modify_date 		AS modifyDate
		FROM
			reservation_info
			INNER JOIN reservation_user_comment
				ON reservation_user_comment.reservation_info_id = reservation_info.id
		WHERE
			reservation_info.product_id = #{id}
	</select>
	
	<select id="selectCommentImageList" parameterType="map" resultType="CommentImage">
		SELECT 
			file_info.content_type 							AS contentType,
			file_info.create_date 							AS createDate,
			file_info.delete_flag 							AS deleteFlag,
			file_info.id 									AS fileId,
			file_info.file_name 							AS fileName,
			reservation_user_comment_image.id 				AS imageId,
			file_info.modify_date 							AS modifyDate,
			reservation_user_comment.reservation_info_id 	AS reservationInfoId,
			reservation_user_comment.id 					AS reservationUserCommentId,
			file_info.save_file_name 						AS saveFileName
		FROM
			reservation_user_comment
			INNER JOIN reservation_user_comment_image
				ON reservation_user_comment_image.reservation_user_comment_id = reservation_user_comment.id
			INNER JOIN file_info
				ON reservation_user_comment_image.file_id = file_info.id
		WHERE
			reservation_user_comment.id = #{id}
	</select>
	
	<select id="selectProductDescription"  parameterType="map" resultType="string">
		SELECT
			description AS productDescription
		FROM
			product
		WHERE
			id = #{id}
	</select>
</mapper>